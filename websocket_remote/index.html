<!DOCTYPE HTML>

<html>
   <head>
      <meta charset="UTF-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>WebSocket Remote Client</title>
      <link rel="stylesheet" media="all" href="bootstrap.min.css">
      <link rel="stylesheet" media="all" href="main.css">

      <script type = "text/javascript">
         var websocketServer = "ws://127.0.0.1:5000"

         document.addEventListener("DOMContentLoaded", () => {
            // possible alert types: alert-primary, alert-success, alert-info, alert-warning, alert-danger
            function addMessage(message, type, hide = 0) {

                if ('content' in document.createElement('template')) {
                    var el = document.querySelector('#sse .transcriptions');
                    // Instantiate the table with the existing HTML tbody
                    // and the row with the template
                    const template = document.querySelector('#transcript-part');

                    // Clone the new row and insert it into the table
                    const clone = template.content.cloneNode(true);
                    let transcriptEl = clone.querySelectorAll(".transcript");
                    transcriptEl[0].classList.add(type);
                    //transcriptEl[0].textContent = message;
                    transcriptEl[0].innerHTML = message;

                    // prepend (should not require scrolling)
                    el.firstChild.before(clone);

                    // if hide time is set, delete the message
                    if (hide > 0) {
                        setTimeout(() => {
                            transcriptEl[0].parentNode.removeChild(transcriptEl[0]);
                        }, hide * 1000);
                    }

                    // append + scroll to bottom
                    // el.appendChild(clone);
                    // const scrollingElement = (document.scrollingElement || document.body);
                    // scrollingElement.scrollTop = scrollingElement.scrollHeight;
                } else {
                    // Find another way to add the rows to the table because
                    // the HTML template element is not supported.
                    var el = document.getElementById('sse');
                    var elemDiv = document.createElement('p');
                    elemDiv.style.cssText = 'width:100%;z-index:100;background:#fff;color:#000;';
                    elemDiv.innerText = message;
                    el.appendChild(elemDiv);
                }
            }

            function WebSocketStart() {
               if ("WebSocket" in window) {               
                  // Let us open a web socket
                  var ws = new ReconnectingWebSocket(websocketServer, null, {reconnectInterval: 5000});

                  function addWSSettingEvent(elementSelector, eventListener) {
                     elements = document.querySelectorAll(elementSelector)
                     elements.forEach(element => {
                        element.addEventListener(eventListener, changeSettings);
                     });
                  }
                  addWSSettingEvent("#settings input", "input");
                  addWSSettingEvent("#settings select", "change");
                  addWSSettingEvent("#settings button", "click");
                  function changeSettings(e) {
                     let name = e.currentTarget.name;
                     let value = undefined;
                     switch (e.currentTarget.type) {
                        case 'checkbox':
                              value = e.currentTarget.checked;
                           break;
                        case 'select-one':
                              value = e.currentTarget.value;
                           break;
                        case 'submit':
                              value = true;
                           break;
                        default:
                           break;
                     }
                     console.log({name: name, type: e.currentTarget.type, value: value});

                     let sendData = {name: name, value: value};
                     ws.send(JSON.stringify(sendData));
                  }

               
                  ws.onopen = function() {
                     document.querySelector("#settings").classList.remove('hidden');
                     // Web Socket is connected.
                     addMessage("Connected.", "alert-info", 3);
                  };
               
                  ws.onmessage = function (evt) {
                     var received_msg = JSON.parse(evt.data);

                     // receiving a transcitption message
                     if (typeof received_msg.text != 'undefined') {
                        console.log(received_msg);
                        txt_translation_html = "";
                        if (typeof received_msg.txt_translation != 'undefined') {
                           txt_translation_html = "<br /><small><sup>[" + received_msg.txt_translation_target + "]</sup> " + received_msg.txt_translation + "</small>"
                        }
                        addMessage("<sup class=\"mainsup\">["+received_msg.language+"]</sup> " + received_msg.text + txt_translation_html, "alert-primary");
                     }
                     
                     // receiving other messages
                     if (typeof received_msg.type != 'undefined' && received_msg.type == "installed_languages") {
                        // list all available langauges
                        var src_lang_el = document.querySelector('#settings #src_lang');
                        var trg_lang_el = document.querySelector('#settings #trg_lang');

                        src_lang_el.replaceChildren("")
                        trg_lang_el.replaceChildren("")
                        
                        for(var i = 0; i < received_msg.data.length; i++) {
                           var opt = received_msg.data[i];

                           var el = document.createElement("option");
                           el.textContent = "[" + opt.code + "] " + opt.name;
                           el.value = opt.code;

                           src_lang_el.appendChild(el);
                           trg_lang_el.appendChild(el.cloneNode(true));
                        }
                     }
                     if (typeof received_msg.type != 'undefined' && received_msg.type == "translate_settings") {
                        // load text translation settings
                        var src_lang_el = document.querySelector('#settings #src_lang');
                        var trg_lang_el = document.querySelector('#settings #trg_lang');
                        var txt_ascii_el = document.querySelector('#settings #txt_ascii');
                        var txt_translate_el = document.querySelector('#settings #txt_translate');
                        
                        src_lang_el.value = received_msg.data.src_lang;
                        trg_lang_el.value = received_msg.data.trg_lang;
                        txt_ascii_el.checked = received_msg.data.txt_ascii;
                        txt_translate_el.checked = received_msg.data.txt_translate;

                        // load whisper settings
                        var whisper_task_el = document.querySelector('#settings #whisper_task');

                        whisper_task_el.value = received_msg.data.whisper_task;
                     }
                     
                  };
               
                  ws.onclose = function() {
                     // websocket is closed.
                     document.querySelector("#settings").classList.add('hidden');
                     addMessage("Connection is closed... retrying", "alert-info", 10);
                  };
               } else {
                  // The browser doesn't support WebSocket
                  alert("WebSocket NOT supported by your Browser!");
               }
            }

            WebSocketStart();
         });
      </script>
      <script>!function(a,b){"function"==typeof define&&define.amd?define([],b):"undefined"!=typeof module&&module.exports?module.exports=b():a.ReconnectingWebSocket=b()}(this,function(){function a(b,c,d){function l(a,b){var c=document.createEvent("CustomEvent");return c.initCustomEvent(a,!1,!1,b),c}var e={debug:!1,automaticOpen:!0,reconnectInterval:1e3,maxReconnectInterval:3e4,reconnectDecay:1.5,timeoutInterval:2e3};d||(d={});for(var f in e)this[f]="undefined"!=typeof d[f]?d[f]:e[f];this.url=b,this.reconnectAttempts=0,this.readyState=WebSocket.CONNECTING,this.protocol=null;var h,g=this,i=!1,j=!1,k=document.createElement("div");k.addEventListener("open",function(a){g.onopen(a)}),k.addEventListener("close",function(a){g.onclose(a)}),k.addEventListener("connecting",function(a){g.onconnecting(a)}),k.addEventListener("message",function(a){g.onmessage(a)}),k.addEventListener("error",function(a){g.onerror(a)}),this.addEventListener=k.addEventListener.bind(k),this.removeEventListener=k.removeEventListener.bind(k),this.dispatchEvent=k.dispatchEvent.bind(k),this.open=function(b){h=new WebSocket(g.url,c||[]),b||k.dispatchEvent(l("connecting")),(g.debug||a.debugAll)&&console.debug("ReconnectingWebSocket","attempt-connect",g.url);var d=h,e=setTimeout(function(){(g.debug||a.debugAll)&&console.debug("ReconnectingWebSocket","connection-timeout",g.url),j=!0,d.close(),j=!1},g.timeoutInterval);h.onopen=function(){clearTimeout(e),(g.debug||a.debugAll)&&console.debug("ReconnectingWebSocket","onopen",g.url),g.protocol=h.protocol,g.readyState=WebSocket.OPEN,g.reconnectAttempts=0;var d=l("open");d.isReconnect=b,b=!1,k.dispatchEvent(d)},h.onclose=function(c){if(clearTimeout(e),h=null,i)g.readyState=WebSocket.CLOSED,k.dispatchEvent(l("close"));else{g.readyState=WebSocket.CONNECTING;var d=l("connecting");d.code=c.code,d.reason=c.reason,d.wasClean=c.wasClean,k.dispatchEvent(d),b||j||((g.debug||a.debugAll)&&console.debug("ReconnectingWebSocket","onclose",g.url),k.dispatchEvent(l("close")));var e=g.reconnectInterval*Math.pow(g.reconnectDecay,g.reconnectAttempts);setTimeout(function(){g.reconnectAttempts++,g.open(!0)},e>g.maxReconnectInterval?g.maxReconnectInterval:e)}},h.onmessage=function(b){(g.debug||a.debugAll)&&console.debug("ReconnectingWebSocket","onmessage",g.url,b.data);var c=l("message");c.data=b.data,k.dispatchEvent(c)},h.onerror=function(b){(g.debug||a.debugAll)&&console.debug("ReconnectingWebSocket","onerror",g.url,b),k.dispatchEvent(l("error"))}},1==this.automaticOpen&&this.open(!1),this.send=function(b){if(h)return(g.debug||a.debugAll)&&console.debug("ReconnectingWebSocket","send",g.url,b),h.send(b);throw"INVALID_STATE_ERR : Pausing to reconnect websocket"},this.close=function(a,b){"undefined"==typeof a&&(a=1e3),i=!0,h&&h.close(a,b)},this.refresh=function(){h&&h.close()}}return a.prototype.onopen=function(){},a.prototype.onclose=function(){},a.prototype.onconnecting=function(){},a.prototype.onmessage=function(){},a.prototype.onerror=function(){},a.debugAll=!1,a.CONNECTING=WebSocket.CONNECTING,a.OPEN=WebSocket.OPEN,a.CLOSING=WebSocket.CLOSING,a.CLOSED=WebSocket.CLOSED,a});</script>
   </head>

    <template id="transcript-part">
        <div class="col-sm-12">
            <div class="transcript alert fade alert-simple alert-dismissible text-left font__family-montserrat font__size-16 font__weight-light brk-library-rendered rendered show">
                -
            </div>
        </div>
    </template>

   <body>
      <div id="settings" class="hidden">
        <section>
            <div class="container mt-5">
               WhisperAI Task:
               <select name="whisper_task" id="whisper_task">
                  <option value="transcribe">transcribe</option>
                  <option value="translate">translate (to en)</option>
               </select>
               <hr />
               <label for="txt_translate">Enable Text Translate:</label> <input type="checkbox" id="txt_translate" name="txt_translate" value="1" />&nbsp;&nbsp;&nbsp;&nbsp;
               <label for="txt_ascii" title="transliterate hiragana, katakana and kanji (Japanese text) into rōmaji">Convert to romaji:</label> <input type="checkbox" id="txt_ascii" name="txt_ascii" value="1" />
               <br />
               Source Language:
               <select name="src_lang" id="src_lang"></select>
               <strong>==></strong>
               Target Language:
               <select name="trg_lang" id="trg_lang"></select>
               &nbsp;&nbsp;&nbsp;&nbsp;
               <button name="dl_langs" value="1">Download Languages</button>
            </div>
         </section>
      </div>

      <div id="sse">
        <section>
            <!--<div class="square_box box_three"></div>
            <div class="square_box box_four"></div>-->
            <div class="container mt-5">
                <div class="row transcriptions">
                    
                </div>
            </div>
        </section>
      </div>
   </body>
</html>
